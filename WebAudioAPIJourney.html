<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>


    <span id="v"></span>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script>
        function isIOS() {
            return /iphone|ipad/i.test(navigator.userAgent);
        }

        var constraints = {
            audio: true
        };

        navigator.mediaDevices.getUserMedia(constraints).then(stream => {
            console.log(`get ${ JSON.stringify(constraints) } ok`);

            let audioCtx = new(window.AudioContext || window.webkitAudioContext)();
            if (isIOS()) {
                // https://developer.apple.com/library/content/documentation/AudioVideo/Conceptual/Using_HTML5_Audio_Video/PlayingandSynthesizingSounds/PlayingandSynthesizingSounds.html
                // Note: On iOS, the Web Audio API requires sounds to be triggered from an explicit user action, such as a tap.
                // so first suspend the audio content, and then add a event listener
                audioCtx.suspend().then(function () {
                    console.log("init suspended when ios");
                });

                document.addEventListener('touchend', function () {
                    if (this.state === 'running') {} else {
                        this.resume().then(() => console.log("resume"));
                    }
                }.bind(audioCtx));
            }

            // define the audio routing graph
            let source = audioCtx.createMediaStreamSource(stream);
            let scriptNode = audioCtx.createScriptProcessor(0, 1, 1);
            source.connect(scriptNode);
            scriptNode.connect(audioCtx.destination);

            scriptNode.onaudioprocess = audioProcessingEvent => {
                let factor = 1000;
                let inputData = audioProcessingEvent.inputBuffer.getChannelData(0);                
                let v = inputData.reduce((a, b) => {
                    return a + b
                });
                
                if (v > 0) {
                    $("#v").text(Math.round(v * factor));
                }
            };
        }).catch(err => {
            console.log(err);
        });
    </script>
</body>

</html>